"use strict";var express=require("express"),Sequelize=require("sequelize"),User=require("../models").User,Course=require("../models").Course,_require=require("express-validator/check"),check=_require.check,validationResult=_require.validationResult,bcryptjs=require("bcryptjs"),auth=require("basic-auth"),colors=require("colors/safe"),router=express.Router();function asyncHandler(n){return function(r,s,t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(n(r,s,t));case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),s.status(500).send(e.t0);case 8:case"end":return e.stop()}},null,null,[[0,5]])}}router.get("/",function(e,r,s){r.json({message:"hello into the api route"})});var authenticateUser=asyncHandler(function(r,s,t){var n,a,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,e.next=3,regeneratorRuntime.awrap(User.findAll({}));case 3:a=e.sent,console.log(a),o=auth(r),console.log(colors.yellow(auth(r))),o?(u=a.find(function(e){return e.emailAddress===o.name}),console.log(colors.green(u)),u?bcryptjs.compareSync(o.pass,u.password)?(console.log("Authentication successful for username: ".concat(u)),r.currentUser=u):n="Authentication failure for username: ".concat(u.username):n="User not found for username: ".concat(o.name)):n="Auth header not found",n?(console.warn(n),s.status(401).json({message:"Access Denied"})):t();case 9:case"end":return e.stop()}})});router.get("/users",authenticateUser,asyncHandler(function(r,s){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.currentUser,s.json({firstName:t.firstName,lastName:t.lastName,emailAddress:t.emailAddress,password:t.password}),e.abrupt("return",s.status(200).end());case 3:case"end":return e.stop()}})})),router.post("/users",[check("firstName").exists({checkNull:!0,checkFalsy:!0}).withMessage('Please provide a value for "firstName"'),check("lastName").exists({checkNull:!0,checkFalsy:!0}).withMessage('Please provide a value for "lastName"'),check("emailAddress").exists({checkNull:!0,checkFalsy:!0}).withMessage('Please provide a value for "password"'),check("password").exists({checkNull:!0,checkFalsy:!0}).withMessage('Please provide a value for "password"')],asyncHandler(function(r,s){var t,n,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if((t=validationResult(r)).isEmpty()){e.next=4;break}return n=t.array().map(function(e){return e.msg}),e.abrupt("return",s.status(400).json({errors:n}));case 4:return a=r.body,console.log("2"),console.log(a),console.log("3"),a.password=bcryptjs.hashSync(a.password),console.log(colors.zebra(a.password)),o=User.build({firstName:r.body.firstName,lastName:r.body.lastName,emailAddress:r.body.emailAddress,password:a.password}),e.next=13,regeneratorRuntime.awrap(o.save());case 13:return s.location="/",console.log(s.location),e.abrupt("return",s.status(201).end());case 16:case"end":return e.stop()}})})),router.get("/courses",asyncHandler(function(e,r){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Course.findAll({include:[{model:User}]}));case 2:s=e.sent,r.json({courses:s}),r.status(200).end();case 5:case"end":return e.stop()}})})),router.get("/courses/:id",asyncHandler(function(r,s){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Course.findOne({where:{id:r.params.id}}));case 2:if(t=e.sent,console.log(t),null!=t)return e.next=7,regeneratorRuntime.awrap(User.findOne({where:{id:t.dataValues.userId}}));e.next=11;break;case 7:n=e.sent,s.json({course:t,owner:n}),e.next=12;break;case 11:s.status(404).json({message:"Course not found."});case 12:case"end":return e.stop()}})}));var checkCourse=[check("title").exists({checkNull:!0,checkFalsy:!0}).withMessage('Please provide a value for "title"'),check("description").exists({checkNull:!0,checkFalsy:!0}).withMessage('Please provide a value for "description"')];router.post("/courses",authenticateUser,checkCourse,asyncHandler(function(r,s){var t,n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if((t=validationResult(r)).isEmpty()){e.next=4;break}return n=t.array().map(function(e){return e.msg}),e.abrupt("return",s.status(400).json({errors:n}));case 4:return a=Course.build({title:r.body.title,description:r.body.description,estimatedTime:r.body.estimatedTime,materialsNeeded:r.body.materialsNeeded,userId:r.body.userId}),e.next=7,regeneratorRuntime.awrap(a.save());case 7:return s.location="/courses/".concat(a.id),console.log(s.location),e.abrupt("return",s.status(201).end());case 10:case"end":return e.stop()}})})),router.put("/courses/:id",authenticateUser,checkCourse,asyncHandler(function(s,r){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if((t=validationResult(s)).isEmpty()){e.next=4;break}return n=t.array().map(function(e){return e.msg}),e.abrupt("return",r.status(400).json({errors:n}));case 4:return e.next=6,regeneratorRuntime.awrap(Course.findOne({where:{id:s.params.id}}).then(function(e){if(!e)throw new Error("No Course found");console.log("retrieved Course ".concat(JSON.stringify(e,null,2)));var r={title:s.body.title,description:s.body.description,estimatedTime:s.body.estimatedTime,materialsNeeded:s.body.materialsNeeded,userId:s.body.userId};e.update(r).then(function(e){console.log("updated Course ".concat(JSON.stringify(e,null,2)))})}).catch(function(e){r.json({message:e.message})}));case 6:return e.abrupt("return",r.status(204).end());case 7:case"end":return e.stop()}})})),router.delete("/courses/:id",authenticateUser,asyncHandler(function(r,s){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Course.findOne({where:{id:r.params.id}}).then(function(e){if(!e)throw new Error("No Course found");console.log("retrieved Course ".concat(JSON.stringify(e,null,2))),e.destroy().then(function(e){console.log("deleted Course ".concat(JSON.stringify(e,null,2)))})}).catch(function(e){s.json({message:e.message})}));case 2:return e.abrupt("return",s.status(204).end());case 3:case"end":return e.stop()}})})),module.exports=router;